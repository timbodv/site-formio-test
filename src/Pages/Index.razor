@page "/"
@implements IAsyncDisposable
@inject IJSRuntime JS

<PageTitle>Index</PageTitle>

<div @ref="unmanagedElement"></div>

@code {
  private ElementReference unmanagedElement;
  private IJSObjectReference? formioModule;
  private IJSObjectReference? formioInstance;

  private string jsonContent = @"
{
  ""display"": ""form"",
  ""components"": [
    {
      ""label"": ""Columns"",
      ""columns"": [
        {
          ""components"": [
            {
              ""label"": ""Environment"",
              ""widget"": ""choicesjs"",
              ""tableView"": true,
              ""data"": {
                ""values"": [
                  {
                    ""label"": ""Production"",
                    ""value"": ""prd""
                  },
                  {
                    ""label"": ""Development"",
                    ""value"": ""dev""
                  }
                ]
              },
              ""key"": ""environment"",
              ""type"": ""select"",
              ""input"": true
            },
            {
              ""label"": ""IP address range"",
              ""tableView"": true,
              ""key"": ""ipAddressRange"",
              ""type"": ""textfield"",
              ""input"": true
            },
            {
              ""label"": ""Solution name"",
              ""tableView"": true,
              ""key"": ""solutionName"",
              ""type"": ""textfield"",
              ""input"": true
            },
            {
              ""label"": ""Acronym / short name"",
              ""tableView"": true,
              ""validate"": {
                ""pattern"": ""^[A-Za-z]+$""
              },
              ""key"": ""acronymOrShortName"",
              ""type"": ""textfield"",
              ""input"": true
            },
            {
              ""label"": ""Solution Name No Spaces ToLower"",
              ""calculateValue"": ""value = data.solutionName.replace(' ','_').toLowerCase();"",
              ""key"": ""solutionNameNoSpacesToLower"",
              ""type"": ""hidden"",
              ""input"": true,
              ""tableView"": false
            },
            {
              ""label"": ""Acronym Or Short Name ToLower"",
              ""calculateValue"": ""value = data.acronymOrShortName.toLowerCase();"",
              ""key"": ""acronymOrShortNameToLower"",
              ""type"": ""hidden"",
              ""input"": true,
              ""tableView"": false
            }
          ],
          ""width"": 6,
          ""offset"": 0,
          ""push"": 0,
          ""pull"": 0,
          ""size"": ""md"",
          ""currentWidth"": 6
        },
        {
          ""components"": [
            {
              ""html"": ""<h3>Azure resource names</h3>"",
              ""label"": ""Content"",
              ""refreshOnChange"": false,
              ""key"": ""content"",
              ""type"": ""content"",
              ""input"": false,
              ""tableView"": false
            },
            {
              ""label"": ""Resource group name"",
              ""tableView"": true,
              ""calculateValue"": ""value = data.solutionNameNoSpacesToLower"",
              ""key"": ""resourceGroupName"",
              ""type"": ""textfield"",
              ""input"": true
            },
            {
              ""label"": ""Subnet name"",
              ""tableView"": true,
              ""calculateValue"": ""value = data.environment + '-' + data.solutionNameNoSpacesToLower + '-' + data.ipAddressRange.replace('/','_');"",
              ""key"": ""textField1"",
              ""type"": ""textfield"",
              ""input"": true
            },
            {
              ""label"": ""Compute - app VM"",
              ""tableView"": true,
              ""calculateValue"": ""value = data.environment + data.acronymOrShortNameToLower + 'app01'"",
              ""key"": ""computeAppVm"",
              ""type"": ""textfield"",
              ""input"": true
            },
            {
              ""label"": ""Compute - web VM"",
              ""tableView"": true,
              ""calculateValue"": ""value = data.environment + data.acronymOrShortNameToLower + 'web01'"",
              ""key"": ""computeWebVm"",
              ""type"": ""textfield"",
              ""input"": true
            },
            {
              ""label"": ""Storage account"",
              ""tableView"": true,
              ""calculateValue"": ""value = '19251001' + data.environment + data.acronymOrShortNameToLower + 'std'"",
              ""key"": ""storageAccount"",
              ""type"": ""textfield"",
              ""input"": true
            }
          ],
          ""width"": 6,
          ""offset"": 0,
          ""push"": 0,
          ""pull"": 0,
          ""size"": ""md"",
          ""currentWidth"": 6
        }
      ],
      ""key"": ""columns"",
      ""type"": ""columns"",
      ""input"": false,
      ""tableView"": false
    },
    {
      ""type"": ""button"",
      ""label"": ""Submit"",
      ""key"": ""submit"",
      ""disableOnInvalid"": true,
      ""input"": true,
      ""tableView"": false
    }
  ]
}
";


  protected override async Task OnAfterRenderAsync(bool firstRender)
  {
    if (firstRender)
    {
      formioModule = await JS.InvokeAsync<IJSObjectReference>("import", "./form.js");
      formioInstance = await formioModule.InvokeAsync<IJSObjectReference>("newForm", unmanagedElement, jsonContent);
    }
  }

  async ValueTask IAsyncDisposable.DisposeAsync()
  {
    if (formioInstance is not null)
    {
      await formioInstance.DisposeAsync();
    }

    if (formioModule is not null)
    {
      await formioModule.DisposeAsync();
    }
  }
}
